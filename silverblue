#!/usr/bin/env bash
cd "$(dirname "${0}")"

menu(){
  while :
  do
    clear
    echo -ne "

███████╗██╗██╗    ██╗   ██╗███████╗██████╗ ██████╗ ██╗     ██╗   ██╗███████╗
██╔════╝██║██║    ██║   ██║██╔════╝██╔══██╗██╔══██╗██║     ██║   ██║██╔════╝
███████╗██║██║    ██║   ██║█████╗  ██████╔╝██████╔╝██║     ██║   ██║█████╗  
╚════██║██║██║    ╚██╗ ██╔╝██╔══╝  ██╔══██╗██╔══██╗██║     ██║   ██║██╔══╝  
███████║██║███████╗╚████╔╝ ███████╗██║  ██║██████╔╝███████╗╚██████╔╝███████╗
╚══════╝╚═╝╚══════╝ ╚═══╝  ╚══════╝╚═╝  ╚═╝╚═════╝ ╚══════╝ ╚═════╝ ╚══════╝

o) OS one time setup (Reboots)
c) Userland one time setup
u) Update OS (Reboots)
l) Update Userland

Select Step:  "
    read -r step
    case $step in
      l) 
        dnf_update
        ;;
      u)
        rpm_ostree_update
        systemctl reboot
        ;;
      o) 
        toolbox create
        rpm_ostree_update
        rpm_ostree_setup
        rpm_ostree_overlays
        systemctl reboot
        ;;
      c)
        dnf_setup
        dnf_update
        dnf_installs
        ;;
      *)
        echo "Not a valid option"
        exit 1
        ;;
    esac
  done
}

rpm_ostree_update(){
  sudo rpm-ostree upgrade
}

rpm_ostree_setup(){
  # set rpm ostree updates to automatic
  sudo cp ./rpm-ostreed.conf /etc
  rpm-ostree reload
  systemctl enable rpm-ostreed-automatic.timer --now
}

rpm_ostree_overlays(){
  rpm-ostree install pop-shell alacritty
}

dnf_setup(){
  # update dnf config
  echo "max_parallel_downloads=10" | sudo tee -a /etc/dnf/dnf.conf
  echo "defaultyes=True" | sudo tee -a /etc/dnf/dnf.conf
  echo "fastestmirror=True" | sudo tee -a /etc/dnf/dnf.conf

  # add rpm fusion repositories
  sudo dnf -y install https://mirrors.rpmfusion.org/free/fedora/rpmfusion-free-release-$(rpm -E %fedora).noarch.rpm
  sudo dnf -y install https://mirrors.rpmfusion.org/nonfree/fedora/rpmfusion-nonfree-release-$(rpm -E %fedora).noarch.rpm
}

dnf_update(){
  sudo dnf -y upgrade
}

dnf_installs(){
  # clis
  sudo dnf -y install bat 
  sudo dnf -y install exa
  sudo dnf -y install fd-find
  sudo dnf -y install fortune-mod
  sudo dnf -y install fzf
  sudo dnf -y install hledger
  sudo dnf -y install ripgrep
  #sudo dnf -y install rmlint
  #sudo dnf -y install starship
  sudo dnf -y install stow
  sudo dnf -y install tealdeer

  # neovim
  sudo dnf -y install neovim
  sudo dnf -y install gcc "gcc-c++" glibc-all-langpacks

  # fish
  sudo dnf -y install fish

  # fish-plugins
  curl -sL https://git.io/fisher | source && fisher install jorgebucaran/fisher
  fisher install PatrickF1/fzf.fish
  fisher install gazorby/fish-exa

  # rustup
  curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
  cargo install cargo-update
  sudo dnf -y install cmake && cargo install starship
  cargo install topgrade

  #====================================================================================# 
  # manual tasks
  #====================================================================================# 
  echo "* Login into Lastpass"
  echo "* Goto Github and add public ssh key"
}

menu
